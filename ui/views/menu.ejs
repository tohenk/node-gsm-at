<% menus = {
    branding: {
        type: 'brand',
        title: apptitle,
        logo: '/images/logo.png',
        url: '/'
    },
    tasks: {
        title: 'Tasks',
        class: 'right floated',
        items: {
            about: {
                title: 'About'
            }
        }
    }
} %>
<% if(user.authenticated) {
    menus.tasks.items.divider1 = {
        type: 'divider'
    }
    menus.tasks.items.sendat = {
        title: 'Send AT command'
    }
    menus.tasks.items.divider2 = {
        type: 'divider'
    }
    menus.tasks.items.logout = {
        title: 'Logout',
        url: '/logout'
    }
} %>
<% block('mainmenu', menu(menus, {mainmenu: true, indentation: 2})); %>
<% script.create('jQuery')
  .useDependencies(['jQuery/Util', 'jQuery/Notification', 'SemanticUI/Dialog/Message'])
  .add(`
$.tasks = {
    notifyResult: function(result) {
        if (result.success) {
            $.ntfy.notify(result.notice ? result.notice : 'Operation successfully submitted!', 'success');
        } else {
            $.ntfy.notify(result.error ? result.error : 'Operation failed!', 'error');
        }
    },
    about: function() {
        var self = this;
        var f = function() {
            var msg = $.util.template('<p>%TITLE% version %VERSION%<br/>' +
                '(c) %AUTHOR%<br/>' +
                'Licensed under %LICENSE%</p>', {
                TITLE: self.aboutInfo.title,
                VERSION: self.aboutInfo.version,
                AUTHOR: $('<div>').text(self.aboutInfo.author).html(),
                LICENSE: self.aboutInfo.license
            });
            $.ntdlg.message('task-about', 'About', msg, $.ntdlg.ICON_INFO);
        }
        if (!self.aboutInfo) {
            $.get('/about').then(function(json) {
                self.aboutInfo = json;
                f();
            });
        } else {
            f();
        }
    },
    sendAt: function() {
        var self = this;
        if ($.term) {
            var termlist = function() {
                var result = [];
                for (var term in $.term.terms) {
                    result.push($.util.template('<option value="%VALUE%">%LABEL%</option>',
                        {VALUE: term, LABEL: term}));
                }
                return result.join('');
            }
            var message =
                '<form class="ui container form">' +
                    '<div class="field">' +
                        '<label>Select terminal:</label>' +
                        '<select name="terminal" class="ui dropdown">' +
                            termlist() +
                        '</select>' +
                    '</div>' +
                    '<div class="field">' +
                        '<label>Command:</label>' +
                        '<input type="text" name="command" value="">' +
                    '</div>' +
                '</form>';
            var dlg = $.ntdlg.dialog('sendatdlg', 'Send AT command', message, 'desktop icon', {
                'okay': {
                    type: 'green approve',
                    caption: '<i class="check icon"></i>Ok',
                    handler: function() {
                        var term = dlg.find('select[name="terminal"]');
                        var cmd = dlg.find('input[name="command"]');
                        if (term.val() == null) {
                            term.focus();
                            return false;
                        }
                        if (cmd.val() == '') {
                            cmd.focus();
                            return false;
                        }
                        $.post('/TERM/at'.replace(/TERM/, term.val()), {command: cmd.val()}).then(function(json) {
                            self.notifyResult(json);
                        });
                        return false;
                    }
                },
                'cancel': {
                    type: 'red deny',
                    caption: '<i class="times icon"></i>Cancel'
                }
            });
            dlg.find('select.dropdown').dropdown();
            $.ntdlg.show(dlg);
        }
    },
    init: function() {
        var self = this;
        $('.menu-about').on('click', function(e) {
            e.preventDefault();
            self.about();
        });
        $('.menu-sendat').on('click', function(e) {
            e.preventDefault();
            self.sendAt();
        });
    }
}
`); %>